<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CARE4UKSA - نظام إدارة الإيرادات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#8a63d2;
  --dark:#1f2330;
  --gray:#6b7280;
  --white:#ffffff;
  --shadow:0 4px 12px rgba(31,35,48,0.1);
  --radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Cairo',sans-serif;background:#f5f1ff;color:var(--dark);line-height:1.7;padding:20px}
.container{max-width:1200px;margin:0 auto}
header{background:white;padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.logo h1{margin:0;color:var(--primary);font-size:24px}
.logo p{margin:4px 0 0 0;color:var(--gray);font-size:14px}
.actions{display:flex;gap:10px}
button{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
.btn-primary{background:var(--primary);color:white}
.btn-outline{background:transparent;color:var(--primary);border:1px solid var(--primary)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;padding:15px;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;border-right:5px solid var(--primary)}
.stat-title{font-size:14px;color:var(--gray)}
.stat-value{font-size:22px;font-weight:700;color:var(--dark)}
.card{background:white;padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px}
h2{color:var(--primary);margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid #eee}
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
.field{display:flex;flex-direction:column;gap:5px}
label{font-size:14px;color:var(--gray)}
input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:15px}
th{background:var(--primary);color:white;padding:12px;text-align:center}
td{padding:10px;border-bottom:1px solid #eee;text-align:center}
tr:nth-child(even){background:#faf8ff}
.btn-sm{padding:6px 10px;font-size:13px;margin:0 3px}
.btn-edit{background:#3b82f6;color:white}
.btn-delete{background:#ef4444;color:white}
.summary{display:flex;justify-content:flex-end;gap:30px;margin-top:20px;font-weight:600;font-size:16px;padding-top:15px;border-top:1px dashed #ccc}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#1f2330;color:white;padding:12px 20px;border-radius:8px;z-index:1000;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}

/* Print design: only header, table, summary, footer */
@media print{
  @page{size:A4;margin:5mm}
  body{background:white;color:black;font-size:11px;padding:0;margin:0}
  .container{max-width:none;margin:0;padding:0}
  header,.stats,.card:nth-of-type(1),#searchBox,.actions,.toast{display:none !important}
  .card:nth-of-type(2){box-shadow:none;border:none;margin:0;padding:0;page-break-inside:avoid}
  table{font-size:9px;margin-top:8px;width:100%}
  th,td{padding:4px 2px;border:1px solid #ccc;line-height:1.2}
  th{background-color:#8a63d2 !important;color:white !important;font-weight:700}
  th.no-print,td.no-print{display:none !important}
  tr{page-break-inside:avoid}
  .summary{font-size:12px;margin-top:10px;border-top:2px solid #8a63d2;padding-top:8px;background:#f9f6ff;padding:8px;border-radius:4px;page-break-inside:avoid}
  .print-header{text-align:center;margin-bottom:10px;padding:8px 0;border-bottom:2px solid #8a63d2;background:#f9f6ff;display:block}
  .print-header h1{font-size:18px;color:#8a63d2;margin:5px 0;font-weight:700}
  .print-header p{color:#6b7280;font-size:11px;margin:3px 0}
  .print-footer{text-align:center;margin-top:15px;font-size:10px;color:#6b7280;border-top:1px solid #ddd;padding-top:5px;display:block}
}

/* small niceties */
@media (max-width:600px){
  .summary{flex-direction:column;align-items:flex-end}
}
#searchBox{width:100%;padding:10px;margin:15px 0;border:1px solid #ddd;border-radius:8px;font-size:16px}
</style>
</head>
<body>

<!-- toast -->
<div class="toast" id="toast">تم الحفظ</div>

<!-- print header (hidden normally, shown on print) -->
<div class="print-header" style="display:none">
  <h1 id="printTitle">سجل إيرادات ذات قروب</h1>
  <p><strong>CARE4UKSA</strong> | الرقم الضريبي: 312062312200003 | التواصل: 920015357</p>
  <p><strong>تاريخ الطباعة:</strong> <span id="printDate"></span></p>
</div>

<div class="container">
  <header>
    <div class="logo">
      <h1>CARE4UKSA</h1>
      <p id="headerSubtitle">نظام إدارة الإيرادات - ذات قروب</p>
    </div>
    <div class="actions">
      <select id="langSelect">
        <option value="ar">العربية</option>
        <option value="en">English</option>
      </select>
      <button id="printBtn" class="btn-outline">🖨️ طباعة</button>
    </div>
  </header>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-title" id="lblTotalRecords">إجمالي السجلات</div>
      <div class="stat-value"><span id="totalRecords">0</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-title" id="lblTotalAmount">إجمالي الإيرادات</div>
      <div class="stat-value"><span id="totalAmount">0.00</span> ر.س</div>
    </div>
    <div class="stat-card">
      <div class="stat-title" id="lblTotalPaid">المدفوع (CARE4U)</div>
      <div class="stat-value"><span id="totalCare4u">0.00</span> ر.س</div>
    </div>
    <div class="stat-card">
      <div class="stat-title" id="lblBalance">الرصيد المستحق</div>
      <div class="stat-value"><span id="balance">0.00</span> ر.س</div>
    </div>
  </div>

  <!-- form card -->
  <div class="card">
    <h2 id="formTitle">إضافة سجل جديد</h2>
    <form id="entryForm">
      <div class="field">
        <label for="fullName" id="lblFullName">الاسم</label>
        <input type="text" id="fullName" required />
      </div>

      <div class="field">
        <label for="nationalId" id="lblNationalId">رقم الهوية</label>
        <input type="text" id="nationalId" required />
      </div>

      <div class="field">
        <label for="amount" id="lblAmount">المبلغ</label>
        <input type="number" id="amount" required step="0.01" min="0.01" />
      </div>

      <div class="field">
        <label for="care4uPay" id="lblCare4uPay">الدفع في CARE4U</label>
        <input type="number" id="care4uPay" step="0.01" min="0" />
      </div>

      <div class="field">
        <label for="serviceType" id="lblServiceType">نوع الخدمة</label>
        <input type="text" id="serviceType" />
      </div>

      <div class="field">
        <label for="extraServices" id="lblExtraServices">خدمات إضافية</label>
        <input type="text" id="extraServices" />
      </div>

      <div class="field">
        <label for="addedDate" id="lblAddedDate">تاريخ الإضافة</label>
        <input type="date" id="addedDate" required />
      </div>

      <div class="field" style="grid-column:span 2">
        <label for="note" id="lblNote">ملاحظات</label>
        <input type="text" id="note" />
      </div>

      <div class="field">
        <button type="submit" id="submitBtn">➕ إضافة</button>
      </div>
    </form>
  </div>

  <!-- table card -->
  <div class="card">
    <h2 id="tableTitle">سجلات الإيرادات</h2>
    <input type="text" id="searchBox" placeholder="ابحث عن اسم أو رقم هوية..." />

    <table id="entriesTable">
      <thead>
        <tr>
          <th>#</th>
          <th id="thFullName">الاسم</th>
          <th id="thNationalId">رقم الهوية</th>
          <th id="thAmount">المبلغ</th>
          <th id="thCare4uPay">الدفع في CARE4U</th>
          <th id="thServiceType">نوع الخدمة</th>
          <th id="thExtraServices">خدمات إضافية</th>
          <th id="thAddedDate">تاريخ الإضافة</th>
          <th id="thActions" class="no-print">الإجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="summary">
      <div><span id="lblSummaryTotal">الإجمالي:</span> <span id="totalDisplay">0.00 ر.س</span></div>
      <div><span id="lblSummaryPaid">المدفوع:</span> <span id="care4uDisplay">0.00 ر.س</span></div>
      <div><span id="lblSummaryBalance">الرصيد:</span> <span id="balanceDisplay" class="highlight">0.00 ر.س</span></div>
    </div>
  </div>
</div>

<!-- print footer -->
<div class="print-footer" style="display:none">
  <p>تم إنشاء هذا التقرير بواسطة نظام إدارة الإيرادات - CARE4UKSA © <span id="footerYear"></span></p>
</div>

<script>
// عناصر
const form = document.getElementById('entryForm');
const tableBody = document.querySelector('#entriesTable tbody');
const toast = document.getElementById('toast');
const langSelect = document.getElementById('langSelect');
const addedDateInput = document.getElementById('addedDate');
const searchBox = document.getElementById('searchBox');

const totalRecordsEl = document.getElementById('totalRecords');
const totalAmountEl = document.getElementById('totalAmount');
const totalCare4uEl = document.getElementById('totalCare4u');
const balanceEl = document.getElementById('balance');
const totalDisplayEl = document.getElementById('totalDisplay');
const care4uDisplayEl = document.getElementById('care4uDisplay');
const balanceDisplayEl = document.getElementById('balanceDisplay');

// ترجمة
const trans = {
  ar:{
    headerSubtitle:'نظام إدارة الإيرادات - ذات قروب', formTitle:'إضافة سجل جديد', tableTitle:'سجلات الإيرادات',
    lblFullName:'الاسم', lblNationalId:'رقم الهوية', lblAmount:'المبلغ', lblCare4uPay:'الدفع في CARE4U',
    lblServiceType:'نوع الخدمة', lblExtraServices:'خدمات إضافية', lblAddedDate:'تاريخ الإضافة', lblNote:'ملاحظات',
    submitBtn:'➕ إضافة', updateBtn:'🔄 تحديث',
    thFullName:'الاسم', thNationalId:'رقم الهوية', thAmount:'المبلغ', thCare4uPay:'الدفع في CARE4U',
    thServiceType:'نوع الخدمة', thExtraServices:'خدمات إضافية', thAddedDate:'تاريخ الإضافة', thActions:'الإجراءات',
    actionEdit:'تعديل', actionDelete:'حذف',
    lblTotalRecords:'إجمالي السجلات', lblTotalAmount:'إجمالي الإيرادات', lblTotalPaid:'المدفوع (CARE4U)', lblBalance:'الرصيد المستحق',
    lblSummaryTotal:'الإجمالي:', lblSummaryPaid:'المدفوع:', lblSummaryBalance:'الرصيد:',
    toastAdd:'تمت الإضافة بنجاح!', toastUpdate:'تم التحديث بنجاح!', toastDelete:'تم الحذف بنجاح!',
    confirmDelete:'هل تريد الحذف؟', searchPlaceholder:'ابحث عن اسم أو رقم هوية أو خدمة...'
  },
  en:{
    headerSubtitle:'Revenue Management - That Group', formTitle:'Add New Record', tableTitle:'Revenue Records',
    lblFullName:'Name', lblNationalId:'National ID', lblAmount:'Amount', lblCare4uPay:'Paid at CARE4U',
    lblServiceType:'Service Type', lblExtraServices:'Extra Services', lblAddedDate:'Added Date', lblNote:'Notes',
    submitBtn:'➕ Add', updateBtn:'🔄 Update',
    thFullName:'Name', thNationalId:'National ID', thAmount:'Amount', thCare4uPay:'Paid at CARE4U',
    thServiceType:'Service Type', thExtraServices:'Extra Services', thAddedDate:'Added Date', thActions:'Actions',
    actionEdit:'Edit', actionDelete:'Delete',
    lblTotalRecords:'Total Records', lblTotalAmount:'Total Revenue', lblTotalPaid:'Paid (CARE4U)', lblBalance:'Balance Due',
    lblSummaryTotal:'Total:', lblSummaryPaid:'Paid:', lblSummaryBalance:'Balance:',
    toastAdd:'Added successfully!', toastUpdate:'Updated successfully!', toastDelete:'Deleted successfully!',
    confirmDelete:'Are you sure?', searchPlaceholder:'Search by name, ID, or service...'
  }
};

let list = [];
let currentLang = 'ar';
let editMode = false;
let editIndex = null;

// عرض رسالة قصيرة
function showToast(msg){
  toast.textContent = msg;
  toast.className = 'toast show';
  setTimeout(()=> toast.className = 'toast', 3000);
}

// تحديث اللغة (يبحث عن عناصر بالـ id المطابقة لمفاتيح الترجمة)
function updateLang(){
  const t = trans[currentLang];
  Object.keys(t).forEach(key=>{
    const el = document.getElementById(key);
    if(el) el.textContent = t[key];
  });
  document.getElementById('submitBtn').textContent = editMode ? t.updateBtn : t.submitBtn;
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  searchBox.placeholder = t.searchPlaceholder;
}

// تعيين تاريخ اليوم
addedDateInput.value = new Date().toISOString().split('T')[0];

// تحميل وحفظ
function loadData(){
  try{
    const saved = localStorage.getItem('revenueData');
    if(saved) list = JSON.parse(saved);
  } catch(e){ list = []; }
  render();
}
function saveData(){ localStorage.setItem('revenueData', JSON.stringify(list)); }

// إضافة / تحديث
form.addEventListener('submit', e=>{
  e.preventDefault();
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const care4uPay = parseFloat(document.getElementById('care4uPay').value) || 0;
  if(care4uPay > amount){ showToast("⚠️ المدفوع لا يمكن أن يتجاوز المبلغ الأصلي!"); return; }

  const data = {
    fullName: document.getElementById('fullName').value.trim(),
    nationalId: document.getElementById('nationalId').value.trim(),
    amount: amount,
    care4uPay: care4uPay,
    serviceType: document.getElementById('serviceType').value.trim(),
    extraServices: document.getElementById('extraServices').value.trim(),
    addedDate: document.getElementById('addedDate').value,
    note: document.getElementById('note').value.trim()
  };

  if(!data.fullName || !data.nationalId){ showToast("⚠️ الاسم ورقم الهوية مطلوبان!"); return; }

  if(editMode){
    list[editIndex] = data;
    showToast(trans[currentLang].toastUpdate);
    editMode = false; editIndex = null;
  } else {
    list.push(data);
    showToast(trans[currentLang].toastAdd);
  }

  saveData();
  render();
  form.reset();
  addedDateInput.value = new Date().toISOString().split('T')[0];
});

// تعديل
window.editRecord = function(index){
  const item = list[index];
  if(!item) return;
  document.getElementById('fullName').value = item.fullName;
  document.getElementById('nationalId').value = item.nationalId;
  document.getElementById('amount').value = item.amount;
  document.getElementById('care4uPay').value = item.care4uPay === 0 ? '' : item.care4uPay;
  document.getElementById('serviceType').value = item.serviceType;
  document.getElementById('extraServices').value = item.extraServices;
  document.getElementById('addedDate').value = item.addedDate;
  document.getElementById('note').value = item.note;
  editMode = true;
  editIndex = index;
  document.getElementById('submitBtn').textContent = trans[currentLang].updateBtn;
  window.scrollTo(0,0);
};

// حذف
window.deleteRecord = function(index){
  if(confirm(trans[currentLang].confirmDelete)){
    list.splice(index,1);
    saveData();
    render();
    showToast(trans[currentLang].toastDelete);
  }
};

// فلترة (بحث يشمل الاسم، رقم الهوية، نوع الخدمة، والخدمات الإضافية)
function filterData(){
  const term = searchBox.value.toLowerCase().trim();
  render(term);
}

// عرض البيانات
function render(searchTerm=''){
  tableBody.innerHTML = '';
  let total = 0, careTotal = 0;
  const sortedList = [...list].sort((a,b)=> new Date(b.addedDate) - new Date(a.addedDate));
  const filteredList = searchTerm ? sortedList.filter(item =>
    item.fullName.toLowerCase().includes(searchTerm) ||
    item.nationalId.includes(searchTerm) ||
    (item.serviceType || '').toLowerCase().includes(searchTerm) ||
    (item.extraServices || '').toLowerCase().includes(searchTerm)
  ) : sortedList;

  filteredList.forEach((item,i)=>{
    total += Number(item.amount || 0);
    careTotal += Number(item.care4uPay || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${item.fullName}</td>
      <td>${item.nationalId}</td>
      <td>${Number(item.amount || 0).toFixed(2)}</td>
      <td>${Number(item.care4uPay || 0) === 0 ? '' : Number(item.care4uPay).toFixed(2)}</td>
      <td>${item.serviceType || ''}</td>
      <td>${item.extraServices || ''}</td>
      <td>${item.addedDate}</td>
      <td class="no-print">
        <button onclick="editRecord(${list.indexOf(item)})" class="btn-sm btn-edit">${trans[currentLang].actionEdit}</button>
        <button onclick="deleteRecord(${list.indexOf(item)})" class="btn-sm btn-delete">${trans[currentLang].actionDelete}</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });

  const balance = total - careTotal;
  totalRecordsEl.textContent = filteredList.length;
  totalAmountEl.textContent = total.toFixed(2);
  totalCare4uEl.textContent = careTotal.toFixed(2);
  balanceEl.textContent = balance.toFixed(2);

  totalDisplayEl.textContent = total.toFixed(2) + ' ر.س';
  care4uDisplayEl.textContent = careTotal.toFixed(2) + ' ر.س';
  balanceDisplayEl.textContent = balance.toFixed(2) + ' ر.س';

  const now = new Date();
  document.getElementById('printDate').textContent = now.toLocaleDateString('ar-SA');
  document.getElementById('footerYear').textContent = now.getFullYear();
}

// طباعة: إظهار رأس وتذييل الطباعة وإخفاء الباقي
document.getElementById('printBtn').onclick = () => {
  document.querySelector('.print-header').style.display = 'block';
  document.querySelector('.print-footer').style.display = 'block';
  document.querySelector('header').style.display = 'none';
  document.querySelector('.stats').style.display = 'none';
  document.querySelectorAll('.card')[0].style.display = 'none';
  document.getElementById('searchBox').style.display = 'none';
  window.print();
  setTimeout(()=>{
    document.querySelector('.print-header').style.display = 'none';
    document.querySelector('.print-footer').style.display = 'none';
    document.querySelector('header').style.display = 'flex';
    document.querySelector('.stats').style.display = 'grid';
    document.querySelectorAll('.card')[0].style.display = 'block';
    document.getElementById('searchBox').style.display = 'block';
  },500);
};

// أحداث
langSelect.addEventListener('change', ()=>{ currentLang = langSelect.value; updateLang(); });
searchBox.addEventListener('input', filterData);
document.addEventListener('DOMContentLoaded', ()=>{ loadData(); updateLang(); });

</script>
</body>
</html>
